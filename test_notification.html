<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知機能テスト - かよ皮膚科予約管理</title>
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        .test-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-btn.success {
            background: #27ae60;
            color: white;
        }
        
        .test-btn.success:hover {
            background: #2ecc71;
            transform: translateY(-2px);
        }
        
        .test-btn.browser {
            background: #3498db;
            color: white;
        }
        
        .test-btn.browser:hover {
            background: #5dade2;
            transform: translateY(-2px);
        }
        
        .test-btn.sound {
            background: #f39c12;
            color: white;
        }
        
        .test-btn.sound:hover {
            background: #f1c40f;
            transform: translateY(-2px);
        }
        
        .test-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .test-info h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .test-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .test-info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-container">
            <h1>🔔 通知機能テスト</h1>
            <p>かよ皮膚科予約管理システムの通知機能をテストできます。</p>
            
            <div class="test-info">
                <h3>📋 テスト項目</h3>
                <ul>
                    <li><strong>成功通知モーダル</strong>: 画面中央に大きな成功通知を表示</li>
                    <li><strong>ブラウザ通知</strong>: デスクトップ通知（許可が必要）</li>
                    <li><strong>音声通知</strong>: 成功音の再生</li>
                    <li><strong>予約番号強調表示</strong>: 予約番号を目立つ形で表示</li>
                </ul>
            </div>
            
            <div class="test-buttons">
                <button class="test-btn success" onclick="testSuccessModal()">
                    🎉 成功通知モーダルテスト
                </button>
                
                <button class="test-btn browser" onclick="testBrowserNotification()">
                    🔔 ブラウザ通知テスト
                </button>
                
                <button class="test-btn sound" onclick="testSound()">
                    🔊 音声通知テスト
                </button>
                
                <button class="test-btn success" onclick="testFullNotification()">
                    🚀 全機能テスト
                </button>
            </div>
            
            <div class="test-info">
                <h3>💡 使用方法</h3>
                <ol>
                    <li>各テストボタンをクリックして機能を確認</li>
                    <li>ブラウザ通知は初回時に許可が必要</li>
                    <li>音声通知はWeb Audio APIを使用</li>
                    <li>成功通知モーダルは予約完了時の動作を再現</li>
                </ol>
            </div>
            
            <div class="test-info">
                <h3>🔧 技術仕様</h3>
                <ul>
                    <li><strong>モーダル</strong>: CSS3 アニメーション + JavaScript</li>
                    <li><strong>ブラウザ通知</strong>: Notification API</li>
                    <li><strong>音声</strong>: Web Audio API</li>
                    <li><strong>レスポンシブ</strong>: モバイル対応</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 通知機能のテスト用関数
        
        function testSuccessModal() {
            showModalNotification('予約完了！', 'テスト用の予約が完了しました！', '予約番号: 12345\n患者番号: 123456\n誕生日: 1990-01-01\n予約日: 2025-08-29\n予約時間: 09:15');
        }
        
        function testBrowserNotification() {
            if (Notification.permission === 'granted') {
                showBrowserNotification('テスト通知', 'これはテスト用のブラウザ通知です');
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showBrowserNotification('テスト通知', 'これはテスト用のブラウザ通知です');
                    } else {
                        alert('ブラウザ通知の許可が必要です');
                    }
                });
            } else {
                alert('ブラウザ通知が拒否されています。設定で許可してください。');
            }
        }
        
        function testSound() {
            playSuccessSound();
        }
        
        function testFullNotification() {
            // 全機能をテスト
            testSuccessModal();
            setTimeout(testBrowserNotification, 500);
            setTimeout(testSound, 1000);
        }
        
        // 通知機能の実装（booking.jsからコピー）
        
        function showModalNotification(title, message, details = '') {
            // 既存のモーダルがあれば削除
            const existingModal = document.getElementById('successModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // モーダル要素を作成
            const modal = document.createElement('div');
            modal.id = 'successModal';
            modal.className = 'success-modal-overlay';
            
            // 予約番号を抽出（detailsから）
            let bookingNumber = '';
            if (details) {
                const match = details.match(/予約番号[：:]\s*(\d+)/);
                if (match) {
                    bookingNumber = match[1];
                }
            }
            
            modal.innerHTML = `
                <div class="success-modal">
                    <div class="success-modal-header">
                        <h2>🎉 ${title}</h2>
                        <button class="modal-close-btn" onclick="closeSuccessModal()">&times;</button>
                    </div>
                    <div class="success-modal-body">
                        <div class="success-icon">✅</div>
                        <p class="success-message">${message}</p>
                        ${details ? `<div class="success-details">${details}</div>` : ''}
                        ${bookingNumber ? `
                            <div class="booking-number-highlight">
                                <span class="label">予約番号</span>
                                <span class="number">${bookingNumber}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="success-modal-footer">
                        <button class="btn btn-secondary" onclick="goToHistory()">📋 予約履歴を確認</button>
                        <button class="btn btn-primary" onclick="closeSuccessModal()">🔄 新規予約</button>
                    </div>
                </div>
            `;
            
            // ページに追加
            document.body.appendChild(modal);
            
            // アニメーション効果
            setTimeout(() => {
                modal.classList.add('show');
            }, 100);
            
            // 10秒後に自動で閉じる
            setTimeout(() => {
                if (modal.parentNode) {
                    closeSuccessModal();
                }
            }, 10000);
        }
        
        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        function goToHistory() {
            alert('予約履歴ページに移動します（テスト用）');
            closeSuccessModal();
        }
        
        function showBrowserNotification(title, message) {
            try {
                const notification = new Notification(title, {
                    body: message,
                    tag: 'test-notification',
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'view',
                            title: '詳細を見る'
                        },
                        {
                            action: 'close',
                            title: '閉じる'
                        }
                    ]
                });
                
                // 通知のクリックイベント
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // 通知のアクションイベント
                notification.onaction = function(event) {
                    if (event.action === 'view') {
                        window.focus();
                        alert('詳細表示（テスト用）');
                    }
                    notification.close();
                };
                
                // 5秒後に自動で閉じる
                setTimeout(() => {
                    notification.close();
                }, 5000);
                
            } catch (error) {
                console.error('ブラウザ通知エラー:', error);
                alert('ブラウザ通知でエラーが発生しました: ' + error.message);
            }
        }
        
        function playSuccessSound() {
            try {
                // Web Audio APIを使用して成功音を生成
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 成功音の設定（2つの音を連続で再生）
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                console.log('音声再生完了');
                
            } catch (error) {
                console.error('音声再生エラー:', error);
                alert('音声再生でエラーが発生しました: ' + error.message);
            }
        }
        
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('通知機能テストページが読み込まれました');
            
            // ブラウザ通知の許可状況を確認
            if (Notification.permission === 'default') {
                console.log('ブラウザ通知の許可が必要です');
            } else if (Notification.permission === 'granted') {
                console.log('ブラウザ通知が許可されています');
            } else {
                console.log('ブラウザ通知が拒否されています');
            }
        });
    </script>
</body>
</html>
